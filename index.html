<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart-Info | Back Office Scheduler</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4472C4;
            --secondary: #2c4a85;
            --bg: #F0F2F5;
            --card-bg: #FFFFFF;
            --text: #333;
            --off-day: #FF9999;
            --off-text: #9C0006;
            --danger: #dc3545;
            --success: #28a745;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; margin: 0; padding: 0; transition: all 0.3s ease; }
        body { background-color: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* === Sidebar Styles === */
        .sidebar {
            width: 250px; background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed; height: 100%; right: 0; z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }
        
        .logo { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .nav-item { padding: 15px; margin-bottom: 10px; cursor: pointer; border-radius: 10px; display: flex; align-items: center; gap: 10px; font-size: 16px; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.2); transform: translateX(-5px); }

        /* === Main Content === */
        .main-content { 
            margin-right: 250px; /* Space for sidebar on desktop */
            width: calc(100% - 250px); 
            padding: 30px; 
            transition: all 0.3s ease;
        }

        /* === Mobile Responsive Logic === */
        .menu-toggle { display: none; } /* Hidden on desktop */
        .overlay { display: none; }

        @media (max-width: 768px) {
            /* Sidebar hidden by default on mobile */
            .sidebar { transform: translateX(100%); right: 0; } 
            .sidebar.active { transform: translateX(0); } /* Slide in */
            
            /* Main content takes full width */
            .main-content { margin-right: 0; width: 100%; padding: 15px; padding-top: 60px; }
            
            /* Hamburger Menu Button */
            .menu-toggle {
                display: block; position: fixed; top: 15px; right: 15px; z-index: 1100;
                background: var(--primary); color: white; border: none; padding: 10px 15px;
                border-radius: 8px; font-size: 20px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }

            /* Overlay background when sidebar is open */
            .overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 900;
                display: none;
            }
            .overlay.active { display: block; }
            
            /* Adjust table font size */
            table { font-size: 12px; }
            th, td { padding: 8px 5px; }
        }

        /* === UI Elements === */
        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 10px; }
        
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-main:hover { background: var(--secondary); transform: translateY(-2px); }
        
        .btn-success { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-decoration: none; display: inline-block;}
        .btn-success:hover { background: #218838; transform: translateY(-2px); }

        .btn-nav { background: white; color: var(--primary); border: 1px solid var(--primary); padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 0 5px; font-weight: bold; font-size: 14px; }
        .btn-nav:hover { background: var(--primary); color: white; }

        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .employee-card { background: var(--card-bg); border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .employee-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 15px; cursor: pointer;}
        
        .card-actions { position: absolute; top: 10px; left: 10px; display: flex; gap: 5px; }
        .action-btn { width: 30px; height: 30px; border-radius: 50%; border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .btn-del { background: rgba(220, 53, 69, 0.8); }
        .btn-del:hover { background: var(--danger); }
        .btn-edit { background: rgba(68, 114, 196, 0.8); }
        .btn-edit:hover { background: var(--secondary); }

        .schedule-container { background: white; padding: 20px; border-radius: 15px; overflow-x: auto; display: none; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; } /* Min width ensures scrolling on mobile */
        th, td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background-color: var(--primary); color: white; }
        .off-cell { background-color: var(--off-day); color: var(--off-text); font-weight: bold; border-radius: 5px; }
        
        .form-container { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); max-width: 600px; margin: 0 auto; display: none; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        input[type="file"] { padding: 10px; background: #f8f9fa; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 500px; max-width: 90%; text-align: center; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate { animation: fadeIn 0.5s ease forwards; }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-calendar-check"></i> Smart-Info</div>
        <div class="nav-item active" onclick="showSection('team'); toggleSidebarOnMobile();"><i class="fas fa-users"></i> فريق العمل</div>
        <div class="nav-item" onclick="showSection('schedule'); toggleSidebarOnMobile();"><i class="fas fa-table"></i> جدول الشفتات</div>
        <div class="nav-item" onclick="showSection('add-emp'); toggleSidebarOnMobile();"><i class="fas fa-user-plus"></i> إضافة موظف</div>
    </div>

    <div class="main-content">
        
        <div id="team-section" class="animate">
            <div class="header-section">
                <h2><i class="fas fa-users"></i> أبطال الـ Back Office</h2>
                <button class="btn-main" onclick="resetForm(); showSection('add-emp');">+ عضو جديد</button>
            </div>
            <div class="team-grid" id="teamGrid"></div>
        </div>

        <div id="add-emp-section" class="form-container animate">
            <h2 id="formTitle" style="text-align: center; margin-bottom: 20px; color: var(--primary);">إضافة موظف جديد</h2>
            <input type="hidden" id="editEmpId">
            <div class="input-group"><label>اسم الموظف</label><input type="text" id="empName" placeholder="الاسم رباعي"></div>
            <div class="input-group"><label>النوع</label><select id="empGender"><option value="male">ذكر</option><option value="female">أنثى</option></select></div>
            <div class="input-group"><label>تاريخ أول يوم عمل</label><input type="date" id="empStartDate"><small style="color: #777;">اتركه فارغاً عند التعديل للحفاظ على النمط.</small></div>
            <div class="input-group"><label>صورة الموظف (اختياري)</label><input type="file" id="empPhotoFile" accept="image/*"></div>
            <button class="btn-main" style="width: 100%" onclick="saveEmployee()">حفظ البيانات</button>
        </div>

        <div id="schedule-section" class="schedule-container animate">
            <div class="header-section">
                <h2><i class="fas fa-calendar-alt"></i> جدول الشفتات</h2>
                <div><button class="btn-success" onclick="exportFullScheduleEn()"><i class="fas fa-file-excel"></i> تحميل الجدول إنجليزي</button></div>
            </div>
            <div style="display:flex; justify-content:center; align-items:center; margin-bottom:15px; gap:5px; flex-wrap: wrap;">
                <button class="btn-nav" onclick="changeWeek(-1)"><i class="fas fa-chevron-right"></i> السابق</button>
                <span id="currentWeekLabel" style="font-weight: bold; background: #e9ecef; padding: 5px 15px; border-radius: 20px; font-size: 13px;">الأسبوع الحالي</span>
                <button class="btn-nav" onclick="changeWeek(1)">التالي <i class="fas fa-chevron-left"></i></button>
            </div>
            <div style="overflow-x: auto;"> <table id="scheduleTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
            </div>
        </div>

    </div>

    <div id="empModal" class="modal">
        <div class="modal-content">
            <img id="modalImg" src="" class="avatar">
            <h2 id="modalName" style="color: var(--primary);"></h2>
            <p style="color: gray;">Back Office Agent</p>
            <div style="background: #f9f9f9; padding: 15px; margin-top: 20px; border-radius: 10px; text-align: right;">
                <h4>الأجازات في هذا الأسبوع:</h4>
                <p id="modalBreak" style="color: var(--secondary); font-weight: bold;"></p>
            </div>
            <button class="btn-main" style="margin-top: 20px; background: #555;" onclick="closeModal()">إغلاق</button>
        </div>
    </div>

    <script>
        // === Responsive Sidebar Logic ===
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }
        function toggleSidebarOnMobile() {
            // Close sidebar automatically when clicking an item on mobile
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // === Data & Config ===
        const BASE_DATE = new Date('2026-01-10T00:00:00'); 
        let currentWeekOffset = 0; 
        const employeesDefault = [
            { id: 6, name: 'كريم', gender: 'male', photo: '', baseOffset: 0 },
            { id: 3, name: 'هنا', gender: 'female', photo: '', baseOffset: -1 },
            { id: 4, name: 'ندى', gender: 'female', photo: '', baseOffset: 1 },
            { id: 1, name: 'نهلة', gender: 'female', photo: '', baseOffset: 3 },
            { id: 2, name: 'سلمى', gender: 'female', photo: '', baseOffset: 4 },
            { id: 5, name: 'شهد', gender: 'female', photo: '', baseOffset: 5 }
        ];
        let employees = JSON.parse(localStorage.getItem('smartEmployeesV8')) || employeesDefault;

        const maleAvatar = "https://cdn-icons-png.flaticon.com/512/4128/4128176.png";
        const femaleAvatar = "https://cdn-icons-png.flaticon.com/512/4140/4140047.png";

        function init() { renderTeam(); renderSchedule(); }
        function showSection(id) {
            document.querySelectorAll('.main-content > div').forEach(div => div.style.display = 'none');
            document.getElementById(id + '-section').style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(id === 'team') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(id === 'schedule') { document.querySelectorAll('.nav-item')[1].classList.add('active'); renderSchedule(); }
            if(id === 'add-emp') document.querySelectorAll('.nav-item')[2].classList.add('active');
        }

        function isDayOff(empBaseOffset, daysSinceBase) {
            const n = daysSinceBase - empBaseOffset;
            const m = 8; 
            const rem = ((n % m) + m) % m;
            return rem === 0 || rem === 1;
        }

        function renderTeam() {
            const grid = document.getElementById('teamGrid');
            grid.innerHTML = '';
            employees.forEach(emp => {
                let imgSrc = emp.photo || (emp.gender === 'male' ? maleAvatar : femaleAvatar);
                grid.innerHTML += `
                    <div class="employee-card">
                        <div class="card-actions">
                            <button class="action-btn btn-del" onclick="deleteEmployee(${emp.id})" title="حذف"><i class="fas fa-trash"></i></button>
                            <button class="action-btn btn-edit" onclick="editEmployee(${emp.id})" title="تعديل"><i class="fas fa-pen"></i></button>
                        </div>
                        <img src="${imgSrc}" class="avatar" onclick="openEmpModal(${emp.id})">
                        <div class="emp-name">${emp.name}</div>
                        <div class="emp-role">Back Office</div>
                    </div>`;
            });
        }

        function resetForm() {
            document.getElementById('formTitle').innerText = "إضافة موظف جديد";
            document.getElementById('editEmpId').value = "";
            document.getElementById('empName').value = "";
            document.getElementById('empGender').value = "male";
            document.getElementById('empStartDate').value = "";
            document.getElementById('empPhotoFile').value = "";
        }
        function editEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            resetForm();
            document.getElementById('formTitle').innerText = "تعديل بيانات الموظف";
            document.getElementById('editEmpId').value = emp.id;
            document.getElementById('empName').value = emp.name;
            document.getElementById('empGender').value = emp.gender;
            showSection('add-emp');
        }
        function saveEmployee() {
            const id = document.getElementById('editEmpId').value;
            const name = document.getElementById('empName').value;
            const gender = document.getElementById('empGender').value;
            const startDateStr = document.getElementById('empStartDate').value;
            const fileInput = document.getElementById('empPhotoFile');
            if (!name) return alert("يرجى إدخال الاسم");

            const processSave = (photoData) => {
                if (id) {
                    const empIndex = employees.findIndex(e => e.id == id);
                    if (empIndex > -1) {
                        employees[empIndex].name = name;
                        employees[empIndex].gender = gender;
                        if (photoData) employees[empIndex].photo = photoData;
                        if (startDateStr) {
                            const startObj = new Date(startDateStr);
                            const timeDiff = startObj - BASE_DATE;
                            employees[empIndex].baseOffset = Math.ceil(timeDiff / 86400000) + 5;
                        }
                    }
                    alert("تم حفظ التعديلات");
                } else {
                    if (!startDateStr) return alert("يرجى إدخال تاريخ البدء");
                    const startObj = new Date(startDateStr);
                    const timeDiff = startObj - BASE_DATE;
                    employees.push({ id: Date.now(), name, gender, photo: photoData, baseOffset: Math.ceil(timeDiff / 86400000) + 5 });
                    alert("تم الإضافة");
                }
                saveData(); resetForm(); showSection('team'); renderTeam();
            };
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { processSave(e.target.result); };
                reader.readAsDataURL(fileInput.files[0]);
            } else { processSave(''); }
        }
        function deleteEmployee(id) {
            if(confirm("حذف الموظف؟")) { employees = employees.filter(e => e.id !== id); saveData(); renderTeam(); renderSchedule(); }
        }

        function changeWeek(direction) { currentWeekOffset += direction; renderSchedule(); }

        function getScheduleDataForOffset(offset) {
            let weekStart = new Date(BASE_DATE);
            weekStart.setDate(weekStart.getDate() + (offset * 7));
            const dayNames = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
            let headers = [];
            let currentDayDate = new Date(weekStart);
            for(let i=0; i<7; i++) {
                let dateStr = currentDayDate.toLocaleDateString('ar-EG', {day:'numeric', month:'numeric'});
                headers.push(`${dayNames[i]} ${dateStr}`);
                currentDayDate.setDate(currentDayDate.getDate() + 1);
            }
            let rows = [];
            employees.forEach((emp, index) => {
                let rowData = { name: emp.name, cells: [] };
                let weekStatus = [];
                let workIndices = [];
                for(let i=0; i<7; i++) {
                    let isOff = isDayOff(emp.baseOffset, (offset * 7) + i);
                    weekStatus.push({ isOff: isOff, time: "" });
                    if(!isOff && i < 6) workIndices.push(i); 
                }
                let isFridayOff = weekStatus[6].isOff;
                if(!isFridayOff) weekStatus[6].time = "13:00";
                
                let pattern = [];
                let isGroupA = (index % 2 === 0); 
                if (!isFridayOff) {
                    if(isGroupA) pattern = ["9:00", "9:00", "10:00", "10:00"];
                    else         pattern = ["10:00", "10:00", "9:00", "9:00"];
                    while(pattern.length < workIndices.length) pattern.push("9:00");
                } else {
                    if(isGroupA) pattern = ["10:00", "10:00", "10:00", "9:00", "9:00"];
                    else         pattern = ["9:00", "9:00", "10:00", "10:00", "10:00"];
                    while(pattern.length < workIndices.length) pattern.push("10:00");
                }
                workIndices.forEach((dayIdx, i) => { if(pattern[i]) weekStatus[dayIdx].time = pattern[i]; });
                weekStatus.forEach(d => rowData.cells.push({ text: d.isOff ? "Off" : d.time, isOff: d.isOff }));
                rows.push(rowData);
            });
            return { weekStart, headers, rows };
        }

        function renderSchedule() {
            const data = getScheduleDataForOffset(currentWeekOffset);
            const options = { month: 'long', day: 'numeric', year: 'numeric' };
            let weekEnd = new Date(data.weekStart); weekEnd.setDate(weekEnd.getDate() + 6);
            document.getElementById('currentWeekLabel').innerText = `أسبوع: ${data.weekStart.toLocaleDateString('ar-EG', options)} - ${weekEnd.toLocaleDateString('ar-EG', options)}`;
            let theadHtml = `<tr><th>الموظف</th>`; data.headers.forEach(h => theadHtml += `<th>${h}</th>`); theadHtml += `</tr>`;
            document.getElementById('tableHead').innerHTML = theadHtml;
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
            data.rows.forEach(row => {
                let rowHtml = `<tr><td style="font-weight:bold; color:var(--secondary)">${row.name}</td>`;
                row.cells.forEach(cell => { rowHtml += cell.isOff ? `<td class="off-cell">Off</td>` : `<td>${cell.text}</td>`; });
                rowHtml += `</tr>`; tbody.innerHTML += rowHtml;
            });
        }

        function exportFullScheduleEn() {
            const nameMap = { 'كريم': 'Kareem', 'هنا': 'Hana', 'ندى': 'Nada', 'نهلة': 'Nahla', 'سلمى': 'Salma', 'شهد': 'Shahd' };
            let tableContent = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>body { direction: ltr; font-family: Calibri, sans-serif; } table { border-collapse: collapse; width: 100%; margin-bottom: 20px; } td, th { border: 1px solid #000; text-align: center; padding: 5px; } th { background-color: #4472C4; color: white; } .off { background-color: #FF9999; color: #9C0006; font-weight: bold; } .name { background-color: #EDEDED; font-weight: bold; text-align: left; } .week-header { background-color: #D9E1F2; font-weight: bold; font-size: 14px; text-align: left; padding: 10px; }</style></head><body>`;
            const engDays = ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
            for (let w = 0; w < 12; w++) {
                const data = getScheduleDataForOffset(w);
                const options = { month: 'long', day: 'numeric', year: 'numeric' };
                let weekEnd = new Date(data.weekStart); weekEnd.setDate(weekEnd.getDate() + 6);
                let range = `${data.weekStart.toLocaleDateString('en-GB', options)} - ${weekEnd.toLocaleDateString('en-GB', options)}`;
                tableContent += `<table><tr><td colspan="8" class="week-header">Week ${w + 1}: ${range}</td></tr><tr><th>Employee</th>`;
                let currentDayDate = new Date(data.weekStart);
                for(let i=0; i<7; i++) { let dateStr = currentDayDate.toLocaleDateString('en-GB', {day:'numeric', month:'short'}); tableContent += `<th>${engDays[i]} <br> ${dateStr}</th>`; currentDayDate.setDate(currentDayDate.getDate() + 1); }
                tableContent += `</tr>`;
                data.rows.forEach(row => {
                    let engName = nameMap[row.name] || row.name;
                    tableContent += `<tr><td class="name">${engName}</td>`;
                    row.cells.forEach(cell => { tableContent += cell.isOff ? `<td class="off">Off</td>` : `<td>${cell.text}</td>`; });
                    tableContent += `</tr>`;
                });
                tableContent += `</table><br>`;
            }
            tableContent += `</body></html>`;
            const blob = new Blob([tableContent], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'Smart_Schedule_English.xls'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function openEmpModal(id) {
            const emp = employees.find(e => e.id === id);
            document.getElementById('modalName').innerText = emp.name;
            document.getElementById('modalImg').src = emp.photo || (emp.gender === 'male'? maleAvatar: femaleAvatar);
            let breakNames = [];
            const dayNames = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
            for(let i=0; i<7; i++) { if(isDayOff(emp.baseOffset, (currentWeekOffset * 7) + i)) breakNames.push(dayNames[i]); }
            document.getElementById('modalBreak').innerText = breakNames.join(" و ");
            document.getElementById('empModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('empModal').style.display = 'none'; }
        function saveData() { localStorage.setItem('smartEmployeesV8', JSON.stringify(employees)); }
        init();
    </script>
</body>
</html>
